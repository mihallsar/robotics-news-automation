name: Daily Robot Catalog Parser

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 06:00 –∏ 18:00 UTC (10:00 –∏ 22:00 –ø–æ –°–∞—Ä–∞—Ç–æ–≤—É)
    - cron: '0 6,18 * * *'
  workflow_dispatch:

jobs:
  parse-robot-catalog:
    runs-on: ubuntu-latest

    steps:
      - name: ü§ñ Parse Robot Catalog via Rube (Optimized, extended logging)
        run: |
          echo "üöÄ Starting optimized robot catalog parser..."
          echo "üéØ Using recipe: rcp_5ajueyVK76BF"
          echo "‚ö° Parallelism: 10 workers"
          echo "üè≠ Manufacturers: 24"

          RESPONSE=$(curl -s -X POST "https://backend.composio.dev/api/v3/recipes/rcp_5ajueyVK76BF/execute" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.COMPOSIO_API_KEY }}" \
            -d '{
              "input_data": {
                "api_key": "prorobotov2024",
                "api_url": "https://robototehnika.vercel.app/api/robots",
                "search_mode": "all",
                "max_robots_per_manufacturer": "all"
              }
            }')

          # –ü–æ–∫–∞–∂–∏ –ø–æ–ª–Ω—ã–π JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–Ω–∞–≥–ª—è–¥–Ω–æ ‚Äî —á—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≤–µ—Ä–Ω—É–ª–æ—Å—å)
          echo "üéØ FULL RECIPE RESPONSE:"
          echo "$RESPONSE" | jq '.'

          # –ü–æ–∫–∞–∂–∏ —á–∏—Å–ª–æ —Ä–µ–∞–ª—å–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Ä–æ–±–æ—Ç–æ–≤ (–∫–ª—é—á –∏—â–µ—Ç –∏ –≤ data.data, –∏ –≤ data)
          COUNT=$(echo "$RESPONSE" | jq '.data.data.robots_published // .data.robots_published // .data.robots_count // .robots_published // empty')
          echo "üü¢ Robots published: $COUNT"

          # –ü–æ–∫–∞–∂–∏ –æ—à–∏–±–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          ERRORS=$(echo "$RESPONSE" | jq '.data.data.errors // .data.errors // .errors // empty')
          if [ ! -z "$ERRORS" ] && [ "$ERRORS" != "null" ]; then
            echo "üõë ERRORS:"
            echo "$ERRORS"
          fi

          echo ""
          echo "‚úÖ Robot catalog parsing completed!"

      - name: ìåä Summary
        run: |
          echo "üéâ Daily robot catalog update finished!"
          echo "üî® New optimized recipe: 21+ manufacturers, 100+robots!"
          echo "Check: https://robototehnika.vercel.app/api/robots"
